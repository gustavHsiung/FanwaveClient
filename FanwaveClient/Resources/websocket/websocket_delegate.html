<!doctype html>
<html>
  <head> 
    <title>socket.io client delegate</title>
    
    <script type="text/javascript" src="./support/socket.io-client/socket.io.js"></script>
    <script type="text/javascript" src="./jquery-1.4.2.js"></script>
    <script type="text/javascript" src="./lowpro.jquery.js"></script>

  </head>
  <body>
    <script type="text/javascript" src="./websocket.js"></script>
    <script type="text/javascript">
    
    	if(!Ti) {
                // Shim to make it run in browser
                var fakeTi = true;
                var Ti = {
                    API:{
                        debug: function(msg){
                            console.debug(msg);
                        },
                    },
                    App:{
                        addEventListener: function(name, func){
                            $(document).bind(name, func);
                        },
                        fireEvent: function(name, data){
                            $(document).trigger(name, [data]);
                        }
                    }
                };
        }
        $('body').attach(WebSocket);
        
        Ti.App.addEventListener('web', function(e) {
        		switch(e.func)
        		{
        			case 'sendMessage':
        				send(e.data.message);
        		}
        	});
      
      function send(msg)
      {
      	  Ti.App.fireEvent('websocket', {
      	  	  to: 'app',
      	  	  from: 'web',
      	  	  func: 'messageDidSend',
      	  	  data: { message:msg }
      	  });
      	  
          socket.send(msg);
      }
      
      function receive(msg) 
      {
      	  Ti.App.fireEvent('websocket', {
      	      to: 'app',
      	      from: 'web',
        	  func: 'receiveMessage',
        	  data: { message:msg }
          });
      };
      
      var socket = new io.Socket("211.22.104.2", 
      							{
      								port: 4000, 
      								rememberTransport: false,
								});
      socket.connect();

      
      socket.on('connect', function() {
          Ti.App.fireEvent('websocket', {
          	to: 'app',
      	    from: 'web',
        	func:'websocketConnected',
        	data: {}
        	});
      });
      
      socket.on('disconnect', function() {
      	  Ti.App.fireEvent('websocket', {
      	  	to: 'app',
      	    from: 'web',
        	func:'websocketDisconnected',
        	data: {}
        	});
      });
      
      socket.on('reconnect', function(){
          Ti.App.fireEvent('websocket', {
          	to: 'app',
      	    from: 'web',
        	func:'websocketReconnected',
        	data: {}
        	});
      });
      
      socket.on('reconnecting', function( nextRetry_ms ){
      	  Ti.App.fireEvent('websocket', {
      	  	to: 'app',
      	    from: 'web',
        	func:'websocketReconnecting',
        	data: { retry:nextRetry_ms }
        	});
      });
      
      socket.on('reconnect_failed', function(){
          Ti.App.fireEvent('websocket', {
          	to: 'app',
      	    from: 'web',
        	func:'websocketReconnectFailed',
        	data: {}
        	});
      });
      
      socket.on('message', function(obj) {
          if ('buffer' in obj)
          {
            for (var i in obj.buffer) receive(obj.buffer[i]);
          }
          else {
        	  receive(obj);
          }
      });
      
    </script>
    
  </body>
</html>